# docker-compose.yml (ส่วนของ N8N Service)

services:
  # N8N Automation Service
  n8n:
    image: n8nio/n8n:latest
    restart: always
    # ENV_FILE สามารถใช้เพื่อเก็บข้อมูลสำคัญ เช่น N8N_HOST, LINE_TOKEN
    env_file:
      - stack.env # ใช้ไฟล์เดียวกับ Next.js หรือใช้ไฟล์แยกได้
    environment:
      # กำหนด URL ภายนอกเพื่อให้ n8n สร้าง Webhook URL ที่ถูกต้อง
      # *** แก้ไขโดเมนตามที่คุณใช้งานจริง ***
      - N8N_HOST=npmh.moph.go.th
      - WEBHOOK_URL=https://npmh.moph.go.th/
      - N8N_PATH=/n8n/
      - N8N_PORT=5678
      - NODE_ENV=production
      # แนะนำให้เปิดใช้งาน Basic Auth เพื่อเข้าถึง UI ของ n8n
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=admin # *** เปลี่ยนรหัสผ่าน ***
      # ... ตัวแปรอื่น ๆ เช่น Database URL (ถ้าใช้ External DB)

    # *** การจัดการพอร์ตเพื่อป้องกันชนกันและเพื่อความปลอดภัย ***
    # เราใช้ 'expose' แทน 'ports' เพื่อไม่เปิดพอร์ต 5678 ออกสู่ Host OS โดยตรง
    # ทำให้ Kong/Reverse Proxy ในเครือข่าย 'kong-net' เท่านั้นที่ติดต่อกับ n8n ได้
    expose:
      - 5678

    volumes:
      # เก็บข้อมูล Workflows, Credentials, และ Log
      - n8n_data:/home/node/.n8n

    # networks:
    #   - default # ใช้ Network ชื่อ default ซึ่ง map กับ kong-net

# ******************************************************************************
# ส่วนนี้ต้องอยู่ท้ายไฟล์เสมอเพื่อเชื่อมต่อเข้ากับ Kong Network
networks:
  default:
    name: kong-net
    external: true

volumes:
  n8n_data:
